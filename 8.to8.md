# C#åå°„ä¸ç‰¹æ€§(å…«)ï¼šåå°„æ“ä½œè¿›é˜¶



ã€ŠC# åå°„ä¸ç‰¹æ€§ã€‹å·²ç»å®Œæˆäº†ä¸ƒç¯‡ï¼Œè®²è§£äº†åå°„çš„ä½¿ç”¨å’Œå®è·µåº”ç”¨ï¼Œç¬¬å…­å’Œç¬¬ä¸ƒç¯‡å¯¹åå°„ç‰¹æ€§ç­‰è¿›è¡Œäº†å®è·µæ€»ç»“ç»ƒä¹ ï¼Œå­¦ä¹ å®Œæ¯•åï¼Œå¯ä»¥å¯¹ä¸€èˆ¬çš„å®é™…åœºæ™¯è¿›è¡Œåº”ç”¨ï¼Œè§£å†³é—®é¢˜ã€‚

å‰é¢ä¸»è¦è€ƒè™‘å…¥é—¨åŸºç¡€å’Œç»ƒä¹ ï¼Œå­¦ä¹ å®Œæ¯•åå¯ä»¥æŒæ¡åŸºæœ¬çŸ¥è¯†ï¼›æœ¬ç¯‡æ˜¯å¯¹å‰é¢ä¸ƒç¯‡çš„ä¸€äº›æ‹“å±•ï¼Œè§£å†³å‰é¢é—ç•™çš„ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œç»§ç»­ç ”ç©¶ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹çš„éœ€æ±‚ï¼›

æœ¬ç¯‡å¯¹ä¸€äº›æ“ä½œç»†èŠ‚è¿›è¡Œäº†è¡¥å……ï¼Œä»‹ç»äº†åå°„çš„å¸¸ç”¨æ“ä½œæ¡ˆä¾‹å’Œç¤ºèŒƒï¼Œä½¿ç”¨å¦ä¸€ç§å½¢å¼è¿›è¡Œæ“ä½œï¼Œ

æœ¬ç³»åˆ—å·²ç»åˆ°äº†ç¬¬ å…« ç¯‡ï¼Œä¸‹ä¸€ç¯‡å°†ä¸»è¦æµ‹ç®—åå°„å„ç§æ“ä½œçš„æ€§èƒ½ã€‚

å¦‚æœæœ¬ç¯‡ç»“æŸï¼Œä½ éœ€è¦äº†è§£çš„åå°„æ“ä½œï¼Œæœ¬ç³»åˆ—è¿˜æ²¡æœ‰ä»‹ç»åˆ°çš„è¯ï¼Œå¯ä»¥è”ç³»ç¬”è€…ï¼Œåœ¨åé¢çš„ç¯‡ç« ä¸­è¡¥ä¸Šã€‚

æœ¬æ–‡çš„ç« èŠ‚è¾ƒå¤šï¼Œå»ºè®®æ”¶è—é˜…è¯»ğŸ˜„ã€‚



## 1ï¼ŒInvokeMember

ä½¿ç”¨æŒ‡å®šçš„ç»‘å®šçº¦æŸå’ŒåŒ¹é…çš„æŒ‡å®šå‚æ•°åˆ—è¡¨åŠåŒºåŸŸæ€§æ¥è°ƒç”¨æŒ‡å®šæˆå‘˜(CultureInfo)ã€‚

è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰æœ‰ç‚¹æ™¦æ¶©éš¾æ‡‚ï¼Œæ²¡äº‹ï¼Œä¸éœ€è¦ç†ä¼šï¼Œç»§ç»­å‘ä¸‹é˜…è¯»ã€‚



å‰é¢æˆ‘ä»¬ä½¿ç”¨ MemberInfo æ¥è·å–ç±»å‹çš„æˆå‘˜å¹¶è¿›è¡Œæ“ä½œï¼Œä¹Ÿä½¿ç”¨äº† PropertyInfo ã€MethodInfo ç­‰ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°çš„æˆå‘˜ï¼Œéƒ½æ˜¯å…¬å¼€æˆå‘˜ã€‚

`InvokeMember` æ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬ä¾¿æ·åœ°è°ƒç”¨é™æ€å¯¹è±¡æˆ–å®ä¾‹å¯¹è±¡çš„æˆå‘˜ï¼Œ åŒ…æ‹¬ç§æœ‰æˆå‘˜ã€ç´¢å¼•å™¨ç­‰ã€‚

InvokeMember æœ‰ä¸»è¦æœ‰ä¸¤ä¸ªé‡è½½ï¼š

```csharp
        public object? InvokeMember(string name, BindingFlags invokeAttr, Binder? binder, object? target, object?[]? args);
```

```csharp
        public object? InvokeMember(string name, BindingFlags invokeAttr, Binder? binder, object? target, object?[]? args, CultureInfo? culture);
```



 æ³¨ï¼šä¸èƒ½ä½¿ç”¨ `InvokeMember` è°ƒç”¨æ³›å‹æ–¹æ³•ã€‚

InvokeMember ä¸­çš„å‚æ•°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªä½¿ç”¨ç¬¬ä¸€ä¸ªé‡è½½æ–¹æ³•ï¼Œç¬¬äºŒä¸ªé‡è½½æ–¹æ³•æ— éå¤šäº†ä¸ª `CultureInfo`ï¼Œç”¨æ¥å¤„ç†è¯­è¨€æ–‡åŒ–å·®åˆ«ï¼Œæœ¬ç¯‡ä¸­å…³äº InvokeMember  çš„ä½¿ç”¨ï¼Œå…¨æ˜¯æŒ‡ç¬¬ä¸€ä¸ªé‡è½½æ–¹æ³•ã€‚



### 1.1 InvokeMember  å‚æ•°

è¿™ä¸€å°èŠ‚ä»‹ç» InvokeMember  æ–¹æ³•çš„å‚æ•°ä½¿ç”¨ä»¥åŠä½œç”¨ï¼Œè·Ÿç€æ–‡ç« ä¸­å‡ºç°çš„ç¤ºä¾‹è¿›è¡Œæ“ä½œï¼Œå°†ä¼šå¸®åŠ©ä½ æ›´å¿«æŒæ¡çŸ¥è¯†ç‚¹ã€‚



#### 1.1.1 name

å®ƒåŒ…å«è¦è°ƒç”¨çš„æ„é€ å‡½æ•°ã€æ–¹æ³•ã€å±æ€§æˆ–å­—æ®µæˆå‘˜çš„åç§°ï¼Œæ³¨æ„åŒºåˆ†å¤§å°å†™ã€‚



#### 1.1.2 invokeAttr

invokeAttrå‚æ•°ï¼Œæ˜¯ BindingFlags æšä¸¾ï¼Œé€šè¿‡ BindingFlags ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šè¦è°ƒç”¨çš„æˆå‘˜çš„ä¿¡æ¯ã€‚

ä¾‹å¦‚ç§æœ‰æˆå‘˜ç”¨ `BindingFlags.NonPublic` ã€é™æ€æˆå‘˜ç”¨`BindingFlags.Static` ï¼Œé€šè¿‡æšä¸¾é›†åˆæ¥ç­›é€‰ï¼Œå¯ä»¥æŸ¥æ‰¾åˆ°éœ€è¦ä½¿ç”¨çš„æˆå‘˜ã€‚



#### 1.1.3 binder

ä¸€èˆ¬ä¸ºç©ºï¼Œå¾ˆå°‘ä½¿ç”¨åˆ°ã€‚ç¬”è€…ä¹Ÿä¸å¤ªæ¸…æ¥šã€‚

binder å¯¹è±¡å®šä¹‰ä¸€ç»„å±æ€§å¹¶å¯ç”¨ç»‘å®šï¼Œè€Œç»‘å®šå¯èƒ½æ¶‰åŠé€‰æ‹©é‡è½½æ–¹æ³•ã€å¼ºåˆ¶å‚æ•°ç±»å‹å’Œé€šè¿‡åå°„è°ƒç”¨æˆå‘˜ã€‚



#### 1.1.4 target

å¯¹å…¶è°ƒç”¨æŒ‡å®šæˆå‘˜çš„å¯¹è±¡ã€‚

å¦‚æœè¦è°ƒç”¨çš„æ˜¯é™æ€å¯¹è±¡çš„æˆå‘˜æˆ–å®ä¾‹çš„é™æ€æˆå‘˜ï¼Œ target åº” nullï¼Œå¦‚æœè¦è°ƒç”¨å®ä¾‹æˆå‘˜ï¼Œåˆ™æ­¤å‚æ•°ä¸ºå®ä¾‹å¯¹è±¡ã€‚



#### 1.1.5 args

ä¼ é€’å‚æ•°ï¼Œä¾‹å¦‚æ–¹æ³•çš„å‚æ•°ã€å±æ€§å­—æ®µçš„å€¼ç­‰ã€‚



#### 1.1.6 è¿”å›

å¦‚æœè°ƒç”¨çš„æ˜¯æ–¹æ³•æˆ–è€…å±æ€§å­—æ®µè·å–æˆå‘˜å€¼ï¼Œåˆ™ä¼šæœ‰è¿”å›å€¼ï¼›å¦‚æœè°ƒç”¨çš„æ˜¯ `void` æ–¹æ³•æˆ–è€…è®¾ç½®å±æ€§å­—æ®µçš„å€¼ã€‚åˆ™è¿”å› `null` ã€‚



#### 1.1.7 BindingFlags

æšä¸¾å€¼ï¼ŒæŒ‡å®šæ§åˆ¶ç»‘å®šä»¥åŠé€šè¿‡åå°„æ‰§è¡Œæˆå‘˜å’Œç±»å‹æœç´¢çš„æ–¹å¼çš„æ ‡è®°ã€‚

ä¸‹é¢è¡¨æ ¼ä¾‹ä¸¾äº†å¸¸ç”¨åœºæ™¯ä¸‹çš„æšä¸¾ï¼Œå¯ä»¥ç”¨ä½œç¬”è®°è®°å½•ï¼Œä¸éœ€è¦è®¤çœŸçœ‹ï¼Œéœ€è¦çš„æ—¶å€™å†å›æ¥çœ‹ã€‚

| æšä¸¾               | å€¼       | è¯´æ˜                                                         |
| ------------------ | -------- | ------------------------------------------------------------ |
| CreateInstance     | 512      | æŒ‡å®šåå°„åº”åˆ›å»ºæŒ‡å®šç±»å‹çš„å®ä¾‹                                 |
| DeclaredOnly       | 2        | æŒ‡å®šåªåº”è€ƒè™‘åœ¨æ‰€æä¾›ç±»å‹çš„å±‚æ¬¡ç»“æ„çº§åˆ«ä¸Šå£°æ˜çš„æˆå‘˜           |
| Default            | 0        | æŒ‡å®šæœªå®šä¹‰ä»»ä½•ç»‘å®šæ ‡å¿—                                       |
| FlattenHierarchy   | 64       | æŒ‡å®šåº”è¿”å›å±‚æ¬¡ç»“æ„å¾€ä¸Šçš„å…¬å…±æˆå‘˜å’Œå—ä¿æŠ¤é™æ€æˆå‘˜ã€‚ ä¸è¿”å›ç»§æ‰¿ç±»ä¸­çš„ç§æœ‰é™æ€æˆå‘˜ã€‚ é™æ€æˆå‘˜åŒ…æ‹¬å­—æ®µã€æ–¹æ³•ã€äº‹ä»¶å’Œå±æ€§ã€‚ ä¸æ”¯æŒåµŒå¥—ç±»å‹ã€‚ |
| GetField           | 1024     | è·å–å­—æ®µçš„å€¼                                                 |
| GetProperty        | 4096     | è·å–å±æ€§çš„å€¼                                                 |
| IgnoreCase         | 1        | æŒ‡å®šåœ¨ç»‘å®šæ—¶ä¸åº”è€ƒè™‘æˆå‘˜åç§°çš„å¤§å°å†™                         |
| IgnoreReturn       | 16777216 | åœ¨ COM äº’æ“ä½œä¸­ç”¨äºæŒ‡å®šå¯ä»¥å¿½ç•¥æˆå‘˜çš„è¿”å›å€¼                  |
| Instance           | 4        | è·å–çš„æ˜¯å®ä¾‹æˆå‘˜                                             |
| InvokeMethod       | 256      | è°ƒç”¨æ–¹æ³•                                                     |
| NonPublic          | 32       | è·å–çš„æ˜¯éå…¬å¼€æˆå‘˜                                           |
| Public             | 16       | è·å–çš„æ˜¯å…¬å¼€æˆå‘˜                                             |
| SetField           | 2048     | ç»™å­—æ®µèµ‹å€¼                                                   |
| SetProperty        | 8192     | ç»™å±æ€§èµ‹å€¼                                                   |
| Static             | 8        | è·å–çš„æ˜¯é™æ€æˆå‘˜                                             |
| SuppressChangeType | 131072   | æœªå®ç°                                                       |



æ ¹æ®æšä¸¾çš„å½±å“ä½œç”¨åˆ†ç±»ï¼š

| å¯è®¿é—®æ€§æ ‡è¯†     | ç»‘å®šå‚æ•°æ ‡è¯†         | æ“ä½œæˆå‘˜æ ‡è¯†       |
| ---------------- | -------------------- | ------------------ |
| DeclaredOnly     | ExactBinding         | CreateInstance     |
| FlattenHierarchy | OptionalParamBinding | GetField           |
| IgnoreCase       |                      | SetField           |
| IgnoreReturn     |                      | GetProperty        |
| Instance         |                      | SetProperty        |
| NonPublic        |                      | InvokeMethod       |
| Public           |                      | PutDispProperty    |
| Static           |                      | PutRefDispProperty |

ä¸Šé¢çš„æšä¸¾ï¼Œé€šè¿‡ç»„åˆï¼Œèƒ½å¤Ÿç­›é€‰å‡ºéœ€è¦çš„æˆå‘˜ã€‚



#### 1.1.8 æ ¹æ®æ˜¯å¦å…¬å¼€

- æŒ‡å®š `BindingFlags.Public` ä»¥åœ¨æœç´¢ä¸­åŒ…æ‹¬å…¬å…±æˆå‘˜ã€‚
- æŒ‡å®š `BindingFlags.NonPublic` ä»¥åœ¨æœç´¢ä¸­åŒ…æ‹¬éå…¬å…±æˆå‘˜ï¼ˆå³ï¼Œç§æœ‰æˆå‘˜ã€å†…éƒ¨æˆå‘˜å’Œå—ä¿æŠ¤æˆå‘˜ï¼‰ã€‚
- æŒ‡å®š `BindingFlags.FlattenHierarchy` ä»¥åœ¨å±‚æ¬¡ç»“æ„ä¸­åŒ…å«é™æ€æˆå‘˜ã€‚



#### 1.1.9 å¤§å°å†™å’Œæœç´¢å±‚æ¬¡

ä»¥ä¸‹ BindingFlags ä¿®é¥°ç¬¦æ ‡å¿—å¯ç”¨äºæ›´æ”¹æœç´¢çš„å·¥ä½œæ–¹å¼ï¼š

- `BindingFlags.IgnoreCase` å¿½ç•¥ `name`çš„å¤§å°å†™ã€‚
- `BindingFlags.DeclaredOnly` ä»…æœç´¢ç±»å‹ä¸Šå£°æ˜çš„æˆå‘˜ï¼Œè€Œä¸æœç´¢ç»§æ‰¿çš„æˆå‘˜ã€‚



å…³äº `DeclaredOnly` ï¼Œå¯ä»¥å‚è€ƒã€ŠC#åå°„ä¸ç‰¹æ€§(äº”)ï¼šç±»å‹æˆå‘˜æ“ä½œã€‹ä¸­çš„ 1.4 å°èŠ‚ã€‚



#### 1.1.10 æŒ‡å®šå¯¹æˆå‘˜è¿›è¡Œä½•ç§æ“ä½œ

ä»¥ä¸‹ BindingFlags è°ƒç”¨æ ‡å¿—å¯ç”¨äºè¡¨ç¤ºè¦å¯¹æˆå‘˜æ‰§è¡Œçš„æ“ä½œï¼š

- `CreateInstance` è°ƒç”¨æ„é€ å‡½æ•°ï¼ˆé‚£ä¹ˆ `name` å°†è¢«å¿½ç•¥ï¼Œå› ä¸ºæ„é€ å‡½æ•°ä¸éœ€è¦åç§°ï¼‰ï¼›

- `InvokeMethod` è°ƒç”¨æ–¹æ³•ï¼ˆä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼‰ï¼›

  

- `GetField` è·å–å­—æ®µçš„å€¼ï¼›

- `SetField` è®¾ç½®å­—æ®µçš„å€¼ï¼›

- `GetProperty` è·å–å±æ€§çš„å€¼ï¼›

- `SetProperty` è®¾ç½®å±æ€§çš„å€¼ï¼›



å¦å¤–ï¼Œæœ‰äº›æ“ä½œå¯èƒ½ä¼šæœ‰å†²çªçš„ï¼Œä¾‹å¦‚ `InvokeMethod` ä¸  `SetField` æˆ– `SetProperty` ã€‚

å¦‚æœå•ç‹¬ä½¿ç”¨ `InvokeMethod` ï¼Œä¼šè‡ªåŠ¨åŒ…å« `BindingFlags.Public`ã€`BindingFlags.Instance` å’Œ `BindingFlags.Static` ã€‚è¿™ä¸€æ¡å¾ˆé‡è¦ã€‚



### 1.2 å®è·µä½¿ç”¨ InvokeMember å’Œæˆå‘˜çš„é‡è½½æ–¹æ³•

æœ¬èŠ‚ä»‹ç» InvokeMember çš„ç”¨æ³•ä»¥åŠ MethodInfo ã€PropertyInfo ç­‰ä½¿ç”¨ BindingFlags çš„é‡è½½æ–¹æ³•ã€‚



åœ¨æ­¤ä¹‹å‰ï¼Œåˆ›å»ºä¸€ä¸ªç±»å‹

```csharp
    public class MyClass
    {

    }
```

Main æ–¹æ³•ä¸­ï¼Œè·å– Type ä»¥åŠ å®ä¾‹åŒ–

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);
```



#### 1.2.1 é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•

Myclass ä¸­å¢åŠ ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼š

```csharp
        public static void A()
        {
            Console.WriteLine("A()æ–¹æ³•è¢«è°ƒç”¨");
        }
        public void B()
        {
            Console.WriteLine("B()æ–¹æ³•è¢«è°ƒç”¨");
        }
```

é€šè¿‡ InvokeMember è°ƒç”¨

```csharp
            type.InvokeMember("A", BindingFlags.InvokeMethod | BindingFlags.Public | BindingFlags.Static, null, null, new object[] { });

            type.InvokeMember("B", BindingFlags.InvokeMethod, null, example, new object[] { });

            type.GetMethod("A").Invoke(null, null);

            type.GetMethod("B").Invoke(example, null);
```

ç¬¬ä¸€ä¸ªè°ƒç”¨é™æ€æ–¹æ³• `A`ï¼Œç¬¬äºŒä¸ªè°ƒç”¨å®ä¾‹æ–¹æ³• `B`ï¼Œç¬¬ä¸‰ç¬¬å››ä¸ªåˆ™æ˜¯ä½¿ç”¨ MethodInfo æ‰§è¡Œæ–¹æ³•ã€‚

å¦‚æœæ–¹æ³•æ²¡æœ‰å‚æ•°çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ `new object[] { }`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `null`ã€‚

`InvokeMember` æ–¹å¼è°ƒç”¨æ–¹æ³•çš„è¯ï¼Œé™æ€æ–¹æ³•ä½¿ç”¨ `BindingFlags.InvokeMethod | BindingFlags.Public | BindingFlags.Static`ï¼›å®ä¾‹æ–¹æ³•ä½¿ç”¨ `BindingFlags.InvokeMethod`ã€‚

ä½†æ˜¯å¦‚æœå¯¹å®ä¾‹æ–¹æ³•ä½¿ç”¨ ` BindingFlags.InvokeMethod | BindingFlags.Public ` ä¼šæŠ¥é”™ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ



#### 1.2.2 æ–¹æ³•å‚æ•°

ç»™æ–¹æ³•ä¼ é€’å‚æ•°å¾ˆç®€å•ï¼Œä½¿ç”¨ `new object[] { }` å³å¯ã€‚

ä¾‹å¦‚

```csharp
        public void Test(string a, string b)
        {
            Console.WriteLine(a + b);
        }
```

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);

            type.InvokeMember("Test", BindingFlags.InvokeMethod, null, example, new object[] { "666","666" });
```

è¿˜å¯ä»¥ä½¿ç”¨æŒ‡å®šå‘½åå¯¹äºå‚æ•°çš„æ–¹å¼å»è°ƒç”¨æ–¹æ³•ã€‚

ç¤ºä¾‹å¦‚ä¸‹

```csharp
            // æ­£å¸¸å®ä¾‹åŒ–è°ƒç”¨
            (new MyClass()).Test(b: "å‰", a: "å");

            // å‚æ•°çš„å€¼
            var parmA = new object[] { "å‰", "å" };
            // æŒ‡å®šå‚æ•°çš„åç§°
            var parmB = new string[] { "b", "a" };

            type.InvokeMember("Test", BindingFlags.InvokeMethod, null, example, parmA, null, null, parmB);
```





#### 1.2.3  å­—æ®µå±æ€§

BindingFlags ä¸­

- `GetField` è·å–å­—æ®µçš„å€¼ï¼›
- `SetField` è®¾ç½®å­—æ®µçš„å€¼ï¼›
- `GetProperty` è·å–å±æ€§çš„å€¼ï¼›
- `SetProperty` è®¾ç½®å±æ€§çš„å€¼ï¼›

MyClass ä¸­ï¼Œå¢åŠ ä»¥ä¸‹ä»£ç 

```csharp
        public string C = "c";
        public string D { get; set; }
```

Main ä¸­ä½¿ç”¨

```csharp
            type.InvokeMember("C",BindingFlags.SetField,null,example,new object[] { "666"});
            Console.WriteLine(type.InvokeMember("C", BindingFlags.GetField ,null, example, null));

            type.InvokeMember("D", BindingFlags.SetProperty, null, example, new object[] { "666" });
            Console.WriteLine(type.InvokeMember("D", BindingFlags.GetProperty, null, example, null));
```



å¦‚æœä¸ç¡®å®šæ˜¯å±æ€§è¿˜æ˜¯æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ ` BindingFlags.GetField | BindingFlags.GetProperty`ã€‚



#### 1.2.4 é»˜è®¤æˆå‘˜

é€šè¿‡ `DefaultMemberAttribute` ç‰¹æ€§æ ‡è®°ä¸€ä¸ªç±»ä¸­çš„é»˜è®¤æˆå‘˜ï¼Œå¯ä»¥ä½¿ç”¨  `BindingFlags.Default` æ¥è°ƒç”¨ã€‚

```csharp
    [DefaultMemberAttribute("TestA")]
    public class MyClass
    {
        public void TestA(string a, string b)
        {
            Console.WriteLine(a + b);
        }
        public void TestB(string a, string b)
        {
            Console.WriteLine(a);
        }
    }
```

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);

            type.InvokeMember(string.Empty, BindingFlags.InvokeMethod | BindingFlags.Default, null, example, new object[] { "666", "666" });
```

æ­¤æ—¶ï¼Œä¸éœ€è¦ä¼ é€’ name å‚æ•°äº†ã€‚



#### 1.2.5 æ–¹æ³•çš„ refã€out å‚æ•°

å‰é¢ä¸ƒç¯‡å¿˜è®°äº†è¯´ä¸€ä¸‹æ–¹æ³•å‚æ•°ä¸º refã€out çš„æƒ…å†µï¼Œç°åœ¨è¡¥ä¸Šã€‚

å½“å‚æ•°æ˜¯ ref æˆ–è€… out æ—¶ï¼Œå¯ä»¥è¿™æ ·è°ƒç”¨ MethodInfoã€‚

ä½¿ç”¨æ–¹æ³•æ˜¯ï¼šä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚

```csharp
        public void Test(ref string a, ref string b)
        {
            Console.WriteLine($"äº¤äº’å‰ï¼Œa={a},b={b}");
            string c = a;
            b = a;
            a = c;
        }
```

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);

            string[] list = new string[] { "1", "2" };
            MethodInfo method = type.GetMethod("Test");
            method.Invoke(example, list);
            Console.WriteLine($"äº¤æ¢åï¼Œa={list[0]},b={list[1]}");
```



#### 1.2.6 åˆ›å»ºå®ä¾‹

ä»¥å‰çš„ç¯‡ç« ä»¥åŠä»‹ç»è¿‡å®ä¾‹åŒ–ç±»å‹ï¼Œç›´æ¥ `Activator.CreateInstance` å’Œ é€šè¿‡æ„é€ å‡½æ•°ï¼Œç°åœ¨è¿˜å¯ä»¥é€šè¿‡ InvokeMember æ¥å®ä¾‹åŒ–ç±»å‹ã€‚

```csharp
            object example = type.InvokeMember("MyClass", BindingFlags.Public | BindingFlags.Instance | BindingFlags.CreateInstance, null, null, new object[] { });
```

BindingFlags.Instance è¡¨æ˜è¿”å›çš„æ˜¯ä¸€ä¸ªå®ä¾‹ï¼ŒBindingFlags.CreateInstance è¡¨æ˜è¯¥æ“ä½œæ˜¯å®ä¾‹åŒ–ç±»å‹ã€‚

å¦‚æœæ„é€ å‡½æ•°æœ‰å‚æ•°ï¼Œåˆ™ `new object[] { }` é‡Œé¢å¸¦ä¸Šå‚æ•°ã€‚



#### 1.2.7 è®¿é—®æˆå‘˜

ä¹‹å‰å‘¢ï¼Œæˆ‘ä»¬é€šè¿‡ `GetMembers()` æ–¹æ³•è·å–ç±»å‹çš„æ‰€æœ‰æˆå‘˜ï¼Œä¹‹å‰ä½¿ç”¨åˆ°çš„æ–¹æ³•æ˜¯æ— å‚æ•°çš„é‡è½½ã€‚
æœ‰ä¸€ä¸ªä½¿ç”¨äº† BindingFlags çš„é‡è½½æ–¹æ³•å¦‚ä¸‹ï¼š

```csharp
public abstract MemberInfo[] GetMembers(BindingFlags bindingAttr);
```

é€šè¿‡ BindingFlags ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°ç‰¹å®šçš„æˆå‘˜ã€‚

```csharp
            Type type = typeof(List<int>);
            MemberInfo[] memInfo = type.GetMembers(BindingFlags.DeclaredOnly | BindingFlags.Instance | BindingFlags.Public);

            for (int i = 0; i < memInfo.Length; i++)
            {
                Console.WriteLine(memInfo[i].Name);
            }
```

ä¸Šé¢çš„ BindingFlags ï¼ŒBindingFlags.DeclaredOnly  è·å–åœ¨å½“å‰ç±»å‹å®šä¹‰çš„æˆå‘˜(éç»§æ‰¿çš„æˆå‘˜)ã€BindingFlags.Instance è·å–åˆ°å®ä¾‹(å³æœ‰è¿”å›ç»“æœ)ã€BindingFlags.Public è·å–å…¬å¼€çš„æˆå‘˜ã€‚



#### 1.2.8 è°ƒç”¨ç§æœ‰æ–¹æ³•

é€šè¿‡ BindingFlags ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è®¿é—®ç±»å‹çš„ç§æœ‰æ–¹æ³•å¹¶æ‰§è¡Œã€‚



```csharp
    public class MyClass
    {
        private string Test(string a, string b)
        {
            return a + b;
        }
        private void WriteLine(string message)
        {
            Console.WriteLine(message);
        }
    }
```

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);
            MethodInfo[] methods = type.GetMethods(BindingFlags.DeclaredOnly | BindingFlags.Instance | BindingFlags.InvokeMethod | BindingFlags.Public | BindingFlags.NonPublic);

            for (int i = 0; i < methods.Length; i++)
            {
                Console.WriteLine(methods[i].Name);
            }

            MethodInfo method = methods.FirstOrDefault(x => x.Name == "WriteLine");
            method.Invoke(example, new object[] { "æ‰“å°è¾“å‡º" });

```



ä¸Šé¢çš„å‚æ•°ä¸­æŒ‡å®šè·å–ç±»å‹çš„å…¬å¼€å’Œéå…¬å¼€æˆå‘˜æ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯åœ¨å½“å‰ç±»å‹ä¸­å®šä¹‰çš„æˆå‘˜(æ’æŸ¥ç»§æ‰¿çš„æˆå‘˜ï¼Œä¾‹å¦‚ ToString() æ–¹æ³•ç­‰)ï¼Œå¹¶ä¸”è¿”å›äº†å®ä¾‹ã€‚

æ— è®ºæ˜¯å…¬å¼€æ–¹æ³•è¿˜æ˜¯ç§æœ‰æ–¹æ³•ï¼Œåªè¦æ‹¿åˆ° `MethodInfo`ï¼Œå°±å¯ä»¥æ­£å¸¸æ“ä½œäº†ã€‚



#### 1.2.9 ç§æœ‰å±æ€§

è®¿é—®ç§æœ‰å±æ€§ï¼Œè·Ÿç§æœ‰æ–¹æ³•ä¸€æ ·ç®€å•ï¼š

```csharp
    public class MyClass
    {
        /// <summary>
        /// è¿™æ ·çš„å±æ€§æ²¡æœ‰ä»»ä½•æ„ä¹‰
        /// </summary>
        private string A { get; set; }

        /// <summary>
        /// è¿™æ ·çš„å±æ€§ä¼šæŠ¥é”™
        /// </summary>
        // private string B{ get; private set; }
        
        public string C { get; private set; }
    }
```

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);

            PropertyInfo[] properties = type.GetProperties(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.GetProperty | BindingFlags.Instance);
            foreach (var item in properties)
            {
                Console.WriteLine(item.Name);
            }

            PropertyInfo property = properties.FirstOrDefault(x=>x.Name=="A");
            property.SetValue(example,"666");
            Console.WriteLine(property.GetValue(example));

            property = properties.FirstOrDefault(x=>x.Name=="C");
            property.SetValue(example,"777");
            Console.WriteLine(property.GetValue(example));
```



æ— è®ºæ˜¯å…¬å¼€å±æ€§è¿˜æ˜¯ç§æœ‰å±æ€§ï¼Œè¿˜æ˜¯ç§æœ‰æ„é€ å™¨ï¼Œåªè¦æ‹¿åˆ° `MethodInfo`ï¼Œå°±å¯ä»¥æ­£å¸¸æ“ä½œäº†ã€‚



#### 1.2.10 çˆ¶ç±»çš„ç§æœ‰å±æ€§

ç›´æ¥æ’¸ç å°±æ˜¯äº†ã€‚

åˆ›å»ºä¸€ä¸ªç±»å‹

```csharp
    public class A
    {
        private string Test { get; set; }
    }
    public class B : A
    {
    }
    public class C : B
    {

    }
```

```csharp
            Type type = typeof(C);
            PropertyInfo property;
            object example;

            while (true)
            {
                Console.WriteLine($"æŸ¥æ‰¾{type.Name}");
                property = type.GetProperties(
                    BindingFlags.NonPublic |
                    BindingFlags.Instance)
                    .FirstOrDefault(x => x.Name == "Test");
                // å·²ç»æ‰¾åˆ°
                if (property != null)
                {
                    example = Activator.CreateInstance(type);
                    break;
                }
                // å¾€ä¸Šä¸€å±‚æŸ¥æ‰¾
                if (type.BaseType == null)
                    throw new NullReferenceException("æ‰¾ä¸åˆ°å‘€");

                type = type.BaseType;
            }

            property.SetValue(example, "è®¾ç½®å±æ€§å€¼");
            Console.WriteLine(property.GetValue(example));
```



ä¸Šé¢çš„å¾ªç¯ä¼šä¸æ–­çš„å‘ä¸ŠæŸ¥æ‰¾å±æ€§ `Test`ï¼Œç›´åˆ°æ‰¾åˆ°ä½ç½®ã€‚



#### 1.2.11 å±æ€§çš„ GetGetMethod() å’Œ SetGetMethod()

ä¸Šé¢è·å–åˆ°ç§æœ‰å±æ€§çš„ PropertyInfo åï¼Œé€šè¿‡ `SetValue` è®¾ç½®å€¼å’Œ `GetValue` è·å–å€¼ã€‚

é€šè¿‡ `GetGetMethod()` å’Œ `SetGetMethod()` ä¹Ÿå¯ä»¥å®ç°ä¸Šé¢çš„æ“ä½œã€‚

åŸç†æ˜¯ç¼–è¯‘å±æ€§æ—¶ä¼šç”Ÿæˆä¸¤ä¸ªæ–¹æ³•ã€‚

```csharp
    public class MyClass
    {
        private string Test { get; set; }
    }
```

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);

            // GetProperty() ä¼šæŠ¥é”™ï¼Œæ‹¿ä¸åˆ°å±æ€§
            // type.GetProperty("Test", BindingFlags.DeclaredOnly |BindingFlags.NonPublic |BindingFlags.Instance);

            // è·å–åˆ°ç§æœ‰å±æ€§
            PropertyInfo property = type.GetProperties(
                BindingFlags.DeclaredOnly |
                BindingFlags.Public |
                BindingFlags.NonPublic |
                BindingFlags.Instance)
                .FirstOrDefault(x => x.Name == "Test");

            // nonPublic: true è·å–ç§æœ‰æ–¹æ³•
            MethodInfo set = property.GetSetMethod(nonPublic: true);
            set.Invoke(example, new object[] { "æµ‹è¯•" });

            MethodInfo get = property.GetGetMethod(nonPublic:true);
            // è·å–å±æ€§å€¼
            Console.WriteLine(get.Invoke(example, null));
            // è·å–å±æ€§å€¼
            Console.WriteLine(property.GetValue(example));
```

å› ä¸º `GetGetMethod()` å’Œ `SetGetMethod()`  è·å–åˆ°æ–¹æ³•åï¼Œé€šè¿‡ `Invoke` è°ƒç”¨å§”æ‰˜ï¼Œæ®è¯´æ€§èƒ½æ¯”è¾ƒé«˜ã€‚



å½“ç„¶ï¼ŒæŠŠä¸Šé¢çš„å±æ€§æ”¹æˆä¸‹é¢è¿™æ ·ï¼Œç…§æ ·æˆç«‹ã€‚

```csharp
        public string Test { get;private set; }
```



#### 1.2.12 GetAccessors

ä¹‹å‰ã€ŠC#åå°„ä¸ç‰¹æ€§(äº”)ï¼šç±»å‹æˆå‘˜æ“ä½œã€‹2.2 ç« èŠ‚å·²ç»ä»‹ç»è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥é€šè¿‡ GetAccessors() å®Œæˆå±æ€§è¯»å€¼è®¾ç½®å€¼çš„æ“ä½œã€‚



```csharp
    public class MyClass
    {
        public string A { get; set; }
        public string B { get; private set; }
        private string C { get; set; }
    }
```

æ‹¿åˆ°æ‰€æœ‰çš„å±æ€§

```csharp
            Type type = typeof(MyClass);
            object example = Activator.CreateInstance(type);

            // GetProperty() ä¼šæŠ¥é”™ï¼Œæ‹¿ä¸åˆ°å±æ€§
            // type.GetProperty("Test", BindingFlags.DeclaredOnly |BindingFlags.NonPublic |BindingFlags.Instance);

            // è·å–åˆ°ç§æœ‰å±æ€§
            PropertyInfo[] properties = type.GetProperties(
                BindingFlags.DeclaredOnly |
                BindingFlags.Public |
                BindingFlags.NonPublic |
                BindingFlags.Instance);
```



å¼€å§‹æ“ä½œ

```csharp
            // å¾ªç¯æ‰€æœ‰çš„å±æ€§å¹¶ä¸”è°ƒç”¨æ„é€ æ–¹æ³•

            foreach (var item in properties)
            {
                MethodInfo[] methods = item.GetAccessors(nonPublic: true);

                // Set æ–¹æ³•ï¼ŒGet æ–¹æ³•
                MethodInfo mSet = null;
                MethodInfo mGet = null;

                Console.WriteLine("\nå±æ€§   " + item.Name);

                // å…¶å®ä¸€ä¸ªå±æ€§å°±ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸éœ€è¦ä½¿ç”¨ foreach çš„
                foreach (var itemNode in methods)
                {
                    // æ²¡æœ‰è¿”å›å€¼ï¼Œè¯´æ˜å°±æ˜¯ Void set_B(System.String) è¿™æ ·çš„æ–¹æ³•å’¯
                    // å³ set æ„é€ å™¨
                    if (itemNode.ReturnType == typeof(void))
                    {
                        Console.WriteLine("set æ„é€ å™¨    " + itemNode);
                        Console.WriteLine("æ˜¯å¦å…¬æœ‰    " + itemNode.IsPublic);
                        mSet = itemNode;
                    }
                    else
                    {
                        Console.WriteLine("get æ„é€ å™¨    " + itemNode);
                        Console.WriteLine("æ˜¯å¦å…¬æœ‰    " + itemNode.IsPublic);
                        mGet = itemNode;
                    }
                }
                // èµ‹å€¼ï¼Œè¯»å€¼
                mSet.Invoke(example, new object[] { "è®¾ç½®å€¼" });
                Console.WriteLine("è·å–åˆ°å€¼      " + mGet.Invoke(example, null));
            }
```